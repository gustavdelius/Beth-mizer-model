---
title: "Mizer model"
author: "Beth Sleath"
format: pdf
editor: visual
prefer-html: true
---

## Loading library

Load the packages required to design mizer model and produce figures

```{r}
#| message: false
#| warning: false
library(mizer)
library(mizerExperimental)
library(tidyverse)
```

## Setting initial parameters

```{r}
#| message: false
#| warning: false
params <- newSingleSpeciesParams()
params_initial <- setResource(params,
                      resource_dynamics = "resource_semichemostat")
params_double <- params_initial
params_double <- setResource(params_double,
                             resource_level = 0.1)
initialN(params_double) <- 2*initialN(params_double)
initialNResource(params_double) <- initialNResource(params_double)/2

```

## Implementing fishing gear

```{r}
#| message: false
#| warning: false
gear_params(params_double) <- data.frame(
  gear = "gear",
  species = "Target species",
  catchability = 0.3,
  sel_func = "sigmoid_weight",
  sigmoidal_weight = 15,
  sigmoidal_sigma = 5)

params_double <- setFishing(params_double, gear_params = gear_params)

gear_params(params_double)
```

## Simulating ecosystem behaviour

```{r}
sim_double <- project(params_double, t_max = 15, effort = 1)
```

#### Extract and plot yield

```{r}
#| message: false
#| warning: false
getYieldGear(sim_double)
plotYieldGear(sim_double)
```

## Locally reduce resource parameters

##### Calculate current flux

```{r}
N <- finalN(sim_double)["Target species", , drop = TRUE]
w <- w(params_double)

E_growth <- getEGrowth(params_double)["Target species", , drop = TRUE]
gr <- w * E_growth
flux <- gr * N
```

##### Plot initial flux without local reductions

```{r}
#| message: false
#| warning: false
initial_flux_data <- data.frame(Weight = w, 
                             Flux = flux)
initial_flux_plot <- ggplot(initial_flux_data,
                         aes(x = Weight, y = Flux)) +
  geom_smooth() +
  scale_x_log10() +
  scale_y_log10() +
  labs(
    x = paste0("Weight (g)"),
    y = paste0("Flux (g/year)"),
    title = "Flux over increasing weight of fish") +
  theme_classic()
initial_flux_plot
```

##### Locally reduce resource rate

```{r}
#| message: false
#| warning: false
rr <- resource_rate(params_double)
w_full <- w_full(params_double)
w_full[215:240]
rr[215:240] <- rr[215:240] / 100000000

rr_data <- data.frame(
  Weight = params_double@w_full,
  rr = rr
)

rr_plot <- ggplot(rr_data, 
                  aes(x = Weight, y = rr)) +
  geom_smooth() +
  scale_x_log10() + 
  scale_y_log10() +
  theme_classic()
rr_plot
```

##### Locally reduce resource capacity

```{r}
#| message: false
#| warning: false
rc <- resource_capacity(params_double)
w_full[215:240]
rc[215:240] <- rc[215:240] / 10000

rc_data <- data.frame(
  Weight = params_double@w_full,
  rc = rc
)

rc_plot <- ggplot(rc_data, 
                  aes(x = Weight, y = rc)) +
  geom_smooth() +
  scale_x_log10() + 
  scale_y_log10() +
  theme_classic()
rc_plot
```

##### Set new parameters with local resource parameter reductions

```{r}
params_reduced <- setResource(params_double,
                              resource_capacity = rc,
                              resource_rate = rr,
                              balance =  FALSE)
```

## Narrow predation kernel

```{r}
pred_kernel <- getPredKernel(params_reduced)

pred_kernel_reduced <- pred_kernel[, , 215, drop = FALSE]

ggplot(melt(pred_kernel_reduced)) +
  geom_line(aes(x = w_pred, y = value)) +
  scale_x_log10()

select(species_params(params_reduced), beta, sigma)
given_species_params(params_reduced)$sigma <- 0.2
given_species_params(params_reduced)$beta <- 100

getPredKernel(params_reduced)[, , 180, drop = FALSE] %>% 
  melt() %>% 
  ggplot() +
  geom_line(aes(x = w_pred, y = value)) +
  scale_x_log10()
```

## Calculate flux after local reductions in resource parameters

```{r}
#| message: false
#| warning: false
sim_reduced <- project(params_reduced, t_max = 15, effort = 1)

N_reduced <- finalN(sim_reduced)["Target species", , drop = TRUE]
w <- w(params_reduced)

E_growth_reduced <- getEGrowth(params_reduced)["Target species", , drop = TRUE]
grr <- w * E_growth_reduced
flux_reduced <- grr * N_reduced


reduced_flux_data <- data.frame(Weight = w, 
                             Flux = flux_reduced)

reduced_flux_plot <- ggplot(reduced_flux_data,
                         aes(x = Weight, y = Flux)) +
  geom_smooth() +
  scale_x_log10() +
  scale_y_log10() +
  labs(
    x = paste0("Weight (g)"),
    y = paste0("Flux (g/year)"),
    title = "Flux with locally reduced resource replenishment rate and resource capacity") +
  theme_classic()

reduced_flux_plot
```
